<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backend API Documentation</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
</head>

<body>
    <nav class="sidebar">
        <div class="brand">
            <div class="brand-logo"></div>
            <div class="brand-title">Backend API</div>
        </div>
        <ul class="nav-links">
            <li><a href="#intro">Overview</a></li>
            <li><a href="#auth">Auth & Accounts</a></li>
            <li><a href="#users-admin">User Admin</a></li>
            <li><a href="#shopkeeper">Shopkeeper Orders</a></li>
            <li><a href="#warehouse">Warehouse Orders</a></li>
            <li><a href="#inventory">Inventory</a></li>
            <li><a href="#rider">Riders</a></li>
            <li><a href="#orders-shared">Orders (Shared)</a></li>
            <li><a href="#payments">Payments</a></li>
            <li><a href="#notifications">Notifications</a></li>
            <li><a href="#analytics">Analytics</a></li>
            <li><a href="#storage">Storage</a></li>
        </ul>
    </nav>

    <main class="main-content">
        <section id="intro">
            <h1>Backend API Documentation</h1>
            <p>Welcome to the Backend platform API documentation. This API powers interactions between Shopkeepers,
                Warehouses, and Riders, providing a robust backend for rural supply and delivery.</p>

            <div
                style="margin-top: 2rem; padding: 1.5rem; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 8px;">
                <div
                    style="display: grid; grid-template-columns: auto 1fr; gap: 1rem; align-items: center; margin-bottom: 0.5rem;">
                    <span style="color: var(--text-secondary); font-size: 0.9rem;">Base URL</span>
                    <code style="background: none; padding: 0;">/api/</code>
                </div>
                <div
                    style="display: grid; grid-template-columns: auto 1fr; gap: 1rem; align-items: center; margin-bottom: 0.5rem;">
                    <span style="color: var(--text-secondary); font-size: 0.9rem;">Auth Header</span>
                    <code style="background: none; padding: 0;">Authorization: Token &lt;your_token&gt;</code>
                </div>
                <div style="display: grid; grid-template-columns: auto 1fr; gap: 1rem; align-items: center;">
                    <span style="color: var(--text-secondary); font-size: 0.9rem;">Content-Type</span>
                    <code style="background: none; padding: 0;">application/json</code>
                </div>
            </div>

            <div style="margin-top: 1rem; font-size: 0.95rem; color: var(--text-secondary);">
                Roles: SHOPKEEPER, WAREHOUSE_MANAGER, RIDER, ADMIN (superusers also allowed).
            </div>
        </section>

        <section id="auth">
            <h2>Auth & Accounts</h2>
            <p>Supabase email OTP flow. Include <code>Authorization: Bearer &lt;access_token&gt;</code> for authenticated calls.</p>
            <p style="margin-bottom: 1.5rem;"><strong>Base URL:</strong> <code>/api/accounts/</code></p>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method post">POST</span>
                    <span class="url">/send-otp/</span>
                </div>
                <h3>Send OTP</h3>
                <p>Send a 6-digit OTP to the supplied email.</p>
                <pre><code>{
  "email": "user@example.com"
}</code></pre>
                <p class="meta">Auth: none</p>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method post">POST</span>
                    <span class="url">/verify-otp/</span>
                </div>
                <h3>Verify OTP</h3>
                <p>Verify OTP, create user if needed, and return Supabase tokens plus user payload.</p>
                <pre><code>{
  "email": "user@example.com",
  "otp": "123456"
}</code></pre>
                <p class="meta">Errors: 400 validation, 401 invalid OTP</p>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method post">POST</span>
                    <span class="url">/logout/</span>
                </div>
                <h3>Logout</h3>
                <p>Invalidates Supabase session using <code>Authorization: Bearer &lt;token&gt;</code>.</p>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="url">/me/</span>
                </div>
                <h3>Current User</h3>
                <p>Returns the authenticated user's profile, role, active/soft-delete flags, and profile image URL.</p>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method post">POST</span>
                    <span class="url">/profile-picture/</span>
                </div>
                <h3>Upload Profile Picture</h3>
                <p>Multipart upload (<code>image</code> field). Accepts jpg/png/webp up to 2MB. Stored in Supabase bucket <code>profile-pictures</code> at <code>{user_id}/profile.&lt;ext&gt;</code>. Upsert enabled.</p>
                <p class="meta">Auth: any authenticated user</p>
            </div>
        </section>

        <section id="users-admin">
            <h2>Admin: Users</h2>
            <p>Super admins manage users including soft-delete lifecycle.</p>
            <p style="margin-bottom: 1.5rem;"><strong>Base URL:</strong> <code>/api/accounts/admin/users/</code></p>

            <div class="endpoint">
                <div class="endpoint-header"><span class="method get">GET</span><span class="url">/</span></div>
                <h3>List Users</h3>
                <p>Filters: <code>include_deleted</code>, <code>role</code>, <code>is_active</code>. Soft-deleted users included when requested.</p>
                <p class="meta">Auth: ADMIN / superuser</p>
            </div>
            <div class="endpoint">
                <div class="endpoint-header"><span class="method get">GET</span><span class="url">/&lt;user_id&gt;/</span></div>
                <h3>User Detail</h3>
                <p>Returns user data plus dependency summary (warehouses, orders, profiles, deliveries).</p>
            </div>
            <div class="endpoint">
                <div class="endpoint-header"><span class="method post">POST</span><span class="url">/&lt;user_id&gt;/deactivate/</span></div>
                <h3>Soft Delete (Deactivate)</h3>
                <p>Sets <code>is_active=false</code> and <code>deleted_at</code>. Self-deactivation and non-admin superuser deletion are blocked.</p>
            </div>
            <div class="endpoint">
                <div class="endpoint-header"><span class="method post">POST</span><span class="url">/&lt;user_id&gt;/restore/</span></div>
                <h3>Restore</h3>
                <p>Clears soft-delete markers.</p>
            </div>
            <div class="endpoint">
                <div class="endpoint-header"><span class="method post">POST</span><span class="url">/&lt;user_id&gt;/delete/</span></div>
                <h3>Hard Delete</h3>
                <p>Requires <code>{"confirm": true}</code> and no dependent data; blocks self-delete and protected superusers.</p>
            </div>
            <div class="endpoint">
                <div class="endpoint-header"><span class="method get">GET</span><span class="url">/&lt;user_id&gt;/dependencies/</span></div>
                <h3>Dependency Check</h3>
                <p>Returns dependency map and recommended action before hard delete.</p>
            </div>
        </section>

        <section id="shopkeeper">
            <h2>Shopkeeper Orders</h2>
            <p>Order lifecycle for shopkeepers. Base URL: <code>/api/shopkeeper/</code></p>

            <div class="endpoint">
                <div class="endpoint-header"><span class="method post">POST</span><span class="url">orders/create/</span></div>
                <h3>Create Order</h3>
                <p>Body: <code>warehouse_id</code>, <code>items</code> [{item_id, quantity}], optional <code>notes</code>. Validates stock, warehouse active/approved, duplicate items, and existing pending/accepted order with same warehouse.</p>
                <p class="meta">Auth: SHOPKEEPER; Throttled; 400 on stock/validation errors.</p>
            </div>
            <div class="endpoint">
                <div class="endpoint-header"><span class="method get">GET</span><span class="url">orders/</span></div>
                <h3>List Orders</h3>
                <p>Lists shopkeeper orders sorted by created_at desc.</p>
            </div>
            <div class="endpoint">
                <div class="endpoint-header"><span class="method get">GET</span><span class="url">orders/&lt;id&gt;/</span></div>
                <h3>Order Detail</h3>
                <p>Includes items and delivery details if present.</p>
            </div>
        </section>

        <section id="warehouse">
            <h2>Warehouse Orders</h2>
            <p>Managed by warehouse admins. Base URL: <code>/api/warehouse/</code></p>

            <div class="endpoint">
                <div class="endpoint-header"><span class="method get">GET</span><span class="url">orders/</span></div>
                <h3>List Orders</h3>
                <p>Filters by optional <code>status</code>; scoped to admin's warehouses.</p>
            </div>
            <div class="endpoint">
                <div class="endpoint-header"><span class="method get">GET</span><span class="url">orders/pending/</span></div>
                <h3>Pending Orders</h3>
                <p>Oldest-first pending orders for admin warehouses.</p>
            </div>
            <div class="endpoint">
                <div class="endpoint-header"><span class="method get">GET</span><span class="url">orders/&lt;id&gt;/</span></div>
                <h3>Order Detail</h3>
                <p>Scoped to warehouses owned by the admin.</p>
            </div>
            <div class="endpoint">
                <div class="endpoint-header"><span class="method post">POST</span><span class="url">orders/&lt;id&gt;/accept/</span></div>
                <h3>Accept Order</h3>
                <p>Validates state transition via OrderStateManager; logs transition.</p>
            </div>
            <div class="endpoint">
                <div class="endpoint-header"><span class="method post">POST</span><span class="url">orders/&lt;id&gt;/reject/</span></div>
                <h3>Reject Order</h3>
                <p>Requires <code>rejection_reason</code> (10-500 chars) and sanitizes input.</p>
            </div>
            <div class="endpoint">
                <div class="endpoint-header"><span class="method post">POST</span><span class="url">orders/assign/</span></div>
                <h3>Assign Rider</h3>
                <p>Body validated to ensure rider belongs to warehouse; creates Delivery and sets order to <code>assigned</code>.</p>
            </div>
        </section>

        <section id="inventory">
            <h2>Inventory</h2>
            <p>Warehouse-scoped item management. Base URL: <code>/api/inventory/warehouses/</code></p>

            <div class="endpoint">
                <div class="endpoint-header"><span class="method get">GET</span><span class="url">&lt;warehouse_id&gt;/items/</span></div>
                <h3>List Items</h3>
                <p>Returns items for a warehouse.</p>
            </div>
            <div class="endpoint">
                <div class="endpoint-header"><span class="method post">POST</span><span class="url">&lt;warehouse_id&gt;/items/</span></div>
                <h3>Create Item</h3>
                <p>Creates inventory item for the warehouse (see validators for stock/price).</p>
            </div>
            <div class="endpoint">
                <div class="endpoint-header"><span class="method get">GET</span><span class="url">&lt;warehouse_id&gt;/items/&lt;item_id&gt;/</span></div>
                <h3>Item Detail</h3>
                <p>Retrieve specific item.</p>
            </div>
            <div class="endpoint">
                <div class="endpoint-header"><span class="method patch">PATCH</span><span class="url">&lt;warehouse_id&gt;/items/&lt;item_id&gt;/</span></div>
                <h3>Update Item</h3>
                <p>Update price/quantity within validation limits.</p>
            </div>
            <div class="endpoint">
                <div class="endpoint-header"><span class="method post">POST</span><span class="url">&lt;warehouse_id&gt;/items/&lt;item_id&gt;/images/</span></div>
                <h3>Upload Item Image</h3>
                <p>Multipart file upload stored in Supabase bucket <code>item-images</code> at <code>{warehouse_id}/{item_id}/{filename}</code> with overwrite.</p>
            </div>
        </section>

        <section id="rider">
            <h2>Riders</h2>
            <p>Comprehensive rider flows. Base URL: <code>/api/riders/</code></p>

            <div class="endpoint">
                <div class="endpoint-header"><span class="method post">POST</span><span class="url">rider/register/</span></div>
                <h3>Register Rider</h3>
                <p>Warehouse admin or super admin links a rider user to a warehouse.</p>
            </div>
            <div class="endpoint">
                <div class="endpoint-header"><span class="method get">GET</span><span class="url">rider/profile/</span></div>
                <h3>Profile</h3>
                <p>Authenticated rider profile with earnings.</p>
            </div>
            <div class="endpoint">
                <div class="endpoint-header"><span class="method post">POST</span><span class="url">rider/location/update/</span></div>
                <h3>Update Location</h3>
                <p>Latitude/longitude update for live tracking.</p>
            </div>
            <div class="endpoint">
                <div class="endpoint-header"><span class="method get">GET</span><span class="url">rider/orders/</span></div>
                <h3>Assigned Orders</h3>
                <p>Orders assigned to the rider (excludes delivered).</p>
            </div>
            <div class="endpoint">
                <div class="endpoint-header"><span class="method patch">PATCH</span><span class="url">rider/orders/update/</span></div>
                <h3>Update Order Status</h3>
                <p>Transitions: assigned → in_transit → delivered. Triggers payout computations.</p>
            </div>
            <div class="endpoint">
                <div class="endpoint-header"><span class="method get">GET</span><span class="url">rider/earnings/</span></div>
                <h3>Earnings Summary</h3>
                <p>Aggregate rider earnings and history.</p>
            </div>
            <div class="endpoint">
                <div class="endpoint-header"><span class="method get">GET</span><span class="url">rider/history/</span></div>
                <h3>Delivery History</h3>
            </div>
            <div class="endpoint">
                <div class="endpoint-header"><span class="method get">GET</span><span class="url">rider/live-location/</span></div>
                <h3>Live Location</h3>
            </div>
            <div class="endpoint">
                <div class="endpoint-header"><span class="method get">GET</span><span class="url">rider/performance/</span></div>
                <h3>Performance Metrics</h3>
            </div>
            <div class="endpoint">
                <div class="endpoint-header"><span class="method post">POST</span><span class="url">rider/availability/update/</span></div>
                <h3>Set Availability</h3>
            </div>
            <div class="endpoint">
                <div class="endpoint-header"><span class="method get">GET</span><span class="url">rider/notifications/</span></div>
                <h3>Rider Notifications</h3>
            </div>
            <div class="endpoint">
                <div class="endpoint-header"><span class="method post">POST</span><span class="url">rider/notifications/&lt;id&gt;/mark-read/</span></div>
                <h3>Mark Rider Notification Read</h3>
            </div>
            <div class="endpoint">
                <div class="endpoint-header"><span class="method get">GET</span><span class="url">warehouse/riders/</span></div>
                <h3>Warehouse Riders</h3>
                <p>Warehouse admin list/metrics endpoints (<code>/warehouse/riders/active/</code>, <code>/warehouse/riders/metrics/</code>).</p>
            </div>
            <div class="endpoint">
                <div class="endpoint-header"><span class="method get">GET</span><span class="url">admin/riders/manage/</span></div>
                <h3>Admin Rider Management</h3>
                <p>Administrative rider controls and payout export (<code>/admin/riders/export/payouts/</code>).</p>
            </div>
        </section>

        <section id="orders-shared">
            <h2>Orders (Shared Routes)</h2>
            <p>Alternate access via <code>/api/orders/</code> mirrors shopkeeper and warehouse endpoints for compatibility.</p>
            <div class="endpoint">
                <div class="endpoint-header"><span class="method post">POST</span><span class="url">shopkeeper/orders/create/</span></div>
                <h3>Create Order (alias)</h3>
            </div>
            <div class="endpoint">
                <div class="endpoint-header"><span class="method get">GET</span><span class="url">warehouse/orders/pending/</span></div>
                <h3>Pending Orders (alias)</h3>
            </div>
            <p style="margin-top: 0.75rem; color: var(--text-secondary);">Use the role-specific bases above for primary integration.</p>
        </section>

        <section id="payments">
            <h2>Payments</h2>
            <p>Handles shopkeeper payments and rider payouts. Base URL: <code>/api/payments/</code></p>

            <div class="endpoint">
                <div class="endpoint-header"><span class="method post">POST</span><span class="url">initiate/</span></div>
                <h3>Initiate Payment</h3>
                <p>Shopkeeper-only. Body: <code>order_id</code>, <code>amount</code>, <code>mode</code> (upi|cash|credit). Validates ownership and amount.</p>
            </div>
            <div class="endpoint">
                <div class="endpoint-header"><span class="method patch">PATCH</span><span class="url">confirm/</span></div>
                <h3>Confirm/Reject Payment</h3>
                <p>Warehouse managers/admins. Body: <code>payment_id</code>, <code>action</code> (confirm|reject). Checks warehouse ownership and pending status.</p>
            </div>
            <div class="endpoint">
                <div class="endpoint-header"><span class="method post">POST</span><span class="url">payouts/process/</span></div>
                <h3>Process Payouts</h3>
                <p>Admins or warehouse managers. Body optional: <code>order_ids</code>, <code>rate_per_km</code>. Computes rider payouts for delivered orders; skips when delivery missing.</p>
            </div>
            <div class="endpoint">
                <div class="endpoint-header"><span class="method get">GET</span><span class="url">payouts/list/</span></div>
                <h3>List Payouts</h3>
                <p>Role-scoped: riders see own, managers see their warehouse, admins see all. Optional <code>status</code> filter.</p>
            </div>
        </section>

        <section id="notifications">
            <h2>Notifications</h2>
            <p>Authenticated notifications. Base URL: <code>/api/notifications/</code></p>

            <div class="endpoint">
                <div class="endpoint-header"><span class="method get">GET</span><span class="url">/</span></div>
                <h3>List Notifications</h3>
                <p>Paginated list (unread first). Query: <code>page</code>, <code>page_size</code>.</p>
            </div>
            <div class="endpoint">
                <div class="endpoint-header"><span class="method patch">PATCH</span><span class="url">/read/</span></div>
                <h3>Mark Read</h3>
                <p>Body: <code>{"notification_id": 1}</code> or <code>{"mark_all": true}</code>. Marks owned notifications.</p>
            </div>
        </section>

        <section id="analytics">
            <h2>Analytics</h2>
            <p>Role-filtered analytics via DRF router. Base URL: <code>/api/analytics/</code></p>
            <div class="endpoint">
                <div class="endpoint-header"><span class="method get">GET</span><span class="url">/</span></div>
                <h3>List Analytics Summaries</h3>
                <p>Query: <code>ref_type</code>, <code>ref_id</code>, <code>date</code>. Results scoped by role.</p>
            </div>
            <div class="endpoint">
                <div class="endpoint-header"><span class="method get">GET</span><span class="url">system/</span></div>
                <h3>System Analytics</h3>
                <p>Admin only. Query: <code>date</code>, <code>days</code>. May return 202 while computing.</p>
            </div>
            <div class="endpoint">
                <div class="endpoint-header"><span class="method get">GET</span><span class="url">warehouse/</span></div>
                <h3>Warehouse Analytics</h3>
                <p>Admins (specify <code>warehouse_id</code>) or auto-scoped managers.</p>
            </div>
            <div class="endpoint">
                <div class="endpoint-header"><span class="method get">GET</span><span class="url">rider/</span></div>
                <h3>Rider Analytics</h3>
                <p>Admins (provide <code>rider_id</code>) or auto-scoped riders.</p>
            </div>
            <div class="endpoint">
                <div class="endpoint-header"><span class="method post">POST</span><span class="url">refresh/</span></div>
                <h3>Trigger Analytics Refresh</h3>
                <p>Admin-only manual recomputation.</p>
            </div>
        </section>

        <section id="storage">
            <h2>Storage</h2>
            <p>Supabase Storage usage for images and documents.</p>
            <ul style="margin-top: 0.75rem; color: var(--text-secondary); line-height: 1.5;">
                <li><code>profile-pictures</code>: <code>{user_id}/profile.ext</code> via <code>/api/accounts/profile-picture/</code> (upsert, 2MB, jpg/png/webp)</li>
                <li><code>item-images</code>: <code>{warehouse_id}/{item_id}/{filename}</code> via <code>/api/inventory/warehouses/&lt;warehouse_id&gt;/items/&lt;item_id&gt;/images/</code></li>
                <li><code>product-images</code>, <code>rider-documents</code>, <code>warehouse-images</code>: helper utilities in backend for uploads</li>
                <li>Signed URLs supported for private buckets; public URLs for public buckets.</li>
            </ul>
        </section>
    </main>
</body>

</html>
